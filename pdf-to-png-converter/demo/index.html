<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>PDF 转 PNG（浏览器 Demo）</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; margin: 24px; }
    header { margin-bottom: 16px; }
    .row { margin: 12px 0; }
    .pages { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }
    .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; background: #fff; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .card header { font-size: 14px; color: #374151; display: flex; justify-content: space-between; align-items: center; }
    canvas { max-width: 100%; height: auto; display: block; background: #f9fafb; }
    .actions { margin-top: 8px; display: flex; gap: 8px; }
    button { cursor: pointer; padding: 6px 10px; border-radius: 6px; border: 1px solid #d1d5db; background: #f3f4f6; }
    button:hover { background: #e5e7eb; }
    .small { font-size: 12px; color: #6b7280; }
  </style>
</head>
<body>
  <header>
    <h2>PDF 转 PNG（浏览器渲染示例）</h2>
    <div class="small">本示例直接使用 pdfjs-dist 在浏览器中渲染到 Canvas，再导出 PNG。</div>
  </header>

  <div class="row">
    <input id="file" type="file" accept="application/pdf" />
    <label class="small" for="scale">缩放：</label>
    <input id="scale" type="number" step="0.1" value="2.0" style="width:72px" />
    <button id="render">开始渲染</button>
  </div>

  <div id="status" class="row small"></div>

  <section id="pages" class="pages"></section>

  <!-- pdfjs-dist 5.x legacy 构建（包含兼容 API） -->
  <script src="https://unpkg.com/pdfjs-dist@5.4.149/legacy/build/pdf.min.js"></script>
  <script>
    const $ = (sel) => document.querySelector(sel);
    const fileInput = $('#file');
    const scaleInput = $('#scale');
    const renderBtn = $('#render');
    const statusEl = $('#status');
    const pagesEl = $('#pages');

    // 指定 worker 脚本（与上面的版本匹配）
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/pdfjs-dist@5.4.149/legacy/build/pdf.worker.min.mjs';

    function setStatus(text) {
      statusEl.textContent = text || '';
    }

    function clearPages() {
      pagesEl.innerHTML = '';
    }

    async function renderPdfToCanvases(arrayBuffer, viewportScale) {
      const loadingTask = pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) });
      const pdf = await loadingTask.promise;
      const total = pdf.numPages;
      setStatus(`读取完成：共 ${total} 页，开始渲染...`);

      const results = [];
      for (let pageNum = 1; pageNum <= total; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const viewport = page.getViewport({ scale: viewportScale });

        const card = document.createElement('div');
        card.className = 'card';
        const head = document.createElement('header');
        head.innerHTML = `<span>第 ${pageNum} 页</span><span class="small">${Math.round(viewport.width)} × ${Math.round(viewport.height)}</span>`;
        const canvas = document.createElement('canvas');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        const ctx = canvas.getContext('2d');

        card.appendChild(head);
        card.appendChild(canvas);

        const actions = document.createElement('div');
        actions.className = 'actions';
        const downloadBtn = document.createElement('button');
        downloadBtn.textContent = '下载 PNG';
        downloadBtn.addEventListener('click', async () => {
          const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png'));
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `page_${pageNum}.png`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(url);
        });
        actions.appendChild(downloadBtn);
        card.appendChild(actions);

        pagesEl.appendChild(card);

        await page.render({ canvasContext: ctx, viewport, canvas }).promise;
        results.push({ pageNum, canvas, width: viewport.width, height: viewport.height });
        setStatus(`已渲染第 ${pageNum}/${total} 页`);
        page.cleanup();
      }

      await pdf.cleanup();
      setStatus(`完成：共渲染 ${results.length} 页。`);
      return results;
    }

    renderBtn.addEventListener('click', async () => {
      try {
        clearPages();
        if (!fileInput.files || fileInput.files.length === 0) {
          setStatus('请选择一个 PDF 文件。');
          return;
        }
        const file = fileInput.files[0];
        const scale = parseFloat(scaleInput.value || '2.0');
        setStatus('正在读取 PDF...');
        const arrayBuffer = await file.arrayBuffer();
        await renderPdfToCanvases(arrayBuffer, Number.isFinite(scale) ? scale : 2.0);
      } catch (err) {
        console.error(err);
        setStatus('渲染失败：' + (err && err.message ? err.message : String(err)));
      }
    });
  </script>
</body>
</html>


